<html>
  <head>
    <meta charset="utf-8"/>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js" type="text/javascript"></script>

    <script src="skulpt/skulpt.min.js" type="text/javascript"></script>
    <script src="skulpt/skulpt-stdlib.js" type="text/javascript"></script>

    <link rel=stylesheet href="codemirror/lib/codemirror.css">
    <link rel=stylesheet href="codemirror/theme/candy_land.css">
    <script src="codemirror/lib/codemirror.js"></script>
    <script src="codemirror/mode/python/python.js"></script>
    <script src="codemirror/mode/javascript/javascript.js"></script>

    <style>
      #log p,
      #output {
        background: #eee;
        padding: 6px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      #main_table {
        width: 100%;
      }

      #main_table td {
        width: 50%;
      }

      .Codemirror {
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .success { background-color: #dff0d8 !important; }
      .info { background-color: #d9edf7 !important; }
      .warning { background-color: #fcf8e3 !important; }
      .error { background-color: #f2dede !important; }
    </style>


    <script type="text/javascript">
      function log(message, severity) {
        // console.log(message);
        console.log((new Error(message)).stack);

        var logElement = document.getElementById('log');
        var logLineElement = document.createElement('p');
        logLineElement.appendChild(document.createTextNode(message));

        if (!!severity) {
          logLineElement.className = severity;
        }

        logElement.appendChild(logLineElement);
      }

      function clearLog() {
        var logElement = document.getElementById('log');
        for (var i = logElement.childNodes.length-1; i >= 0; i--) {
          logElement.removeChild(logElement.childNodes[i]);
        }
      }

      // Appends some text to a pre element.
      function outputFunction(text) {
        var outputElement = document.getElementById("output");
        outputElement.innerHTML = outputElement.innerHTML + text;
      }

      // Read handler that simply reads the built-in files.
      function readHandler(fileToRead) {
        if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][fileToRead] === undefined) {
          var errorMessage = "File not found: '" + fileToRead + "'";
          log(errorMessage, 'error');
          throw errorMessage;
        }
        return Sk.builtinFiles["files"][fileToRead];
      }

      function on_receive_message(code) {
        clearLog();

        var recode = "\nimport urllib.request\n\
onMessageReceive(urllib.request.urlopen('http://0.0.0.0:8000/msg.json').read())";

        var myPromise = Sk.misceval.asyncToPromise(
            Sk.importMainWithBody.bind(this, "<stdin>", false, code + recode, true));

        myPromise.then(
            function(mod) {
              // All is fine.
              // console.log(mod);
            },
            function(err) {
              // Something didn't work right.
              log(err.toString(), 'error');
            });
      }

      function on_send_button(code, message) {
        clearLog();
        var myPromise = Sk.misceval.asyncToPromise(
            Sk.importMainWithBody.bind(this, "<stdin>", false, code + "\nonMessageSend('"+message+"')", true));
        myPromise.then(function(mod) {}, function(err) {log(err.toString(), 'error');});
      }

      function setup() {
        var codeOnMessageReceiveElement = document.getElementById("codeOnMessageReceive");
        var codeOnMessageSendElement = document.getElementById("codeOnMessageSend");
        var outputElement = document.getElementById("output");

        var config = {
          theme: 'candy_land',
          smartIndent: true,
          tabSize: 4,
          lineNumbers: true,
        };

        var codeMirrorSend = CodeMirror.fromTextArea(codeOnMessageSendElement, config);
        var codeMirrorReceive = CodeMirror.fromTextArea(codeOnMessageReceiveElement, config);

        // Configure Skulpt.
        Sk.pre = "output";
        Sk.configure({
            output: outputFunction,
            read: readHandler});

        // Set the "canvas" (actually a pre) for the turtle module.
        (Sk.TurtleGraphics || (Sk.TurtleGraphics = {})).target = 'turtle_canvas';

        // Set up the event handler for the Run button.
        document.getElementById("run_button").addEventListener(
            "click",
            function(event) {
              // CodeMirror exposes .getValue()
              var code = (codeMirrorReceive && codeMirrorReceive.getValue()) || codeElement.value;
              on_receive_message(code);
            });

        document.getElementById("send_button").addEventListener(
            "click",
            function(event) {
              // CodeMirror exposes .getValue()
              var code = (codeMirrorSend && codeMirrorSend.getValue()) || codeElement.value;
              var chatInputText = document.getElementById("chat_input").value

              on_send_button(code, chatInputText);
            });

        function loop_receive() {
          // CodeMirror exposes .getValue()
          var code = (codeMirrorReceive && codeMirrorReceive.getValue()) || codeElement.value;
          on_receive_message(code);

          // loop after 1000 milliseconds.
          window.setTimeout(loop_receive, 1000);
        }

        loop_receive();
      }

      // Do the setup when document is done loading.
      document.addEventListener(
          "DOMContentLoaded",
          function(event) {
            setup();
          });
    </script>
  </head>

  <body>

    <h3>Try This</h3>

    <table id="main_table">
      <tr>
        <td>
          <!-- Show any Python warnings or errors here. -->
          <div id="log">
          </div>

          <form>
            <textarea id="codeOnMessageReceive">
def onMessageReceive(message):
  print message</textarea>

            <textarea id="codeOnMessageSend">
def onMessageSend(message):
  print message</textarea>

            <br />

            <button id="run_button" type="button">Run</button>
          </form>

          <pre id="output" ></pre>

          <!-- If you want turtle graphics include a canvas -->
          <div id="turtle_canvas"></div>
        </td>

        <td>
          <form>
            <div id="chat_output"></div>
            <br />
            <textarea id="chat_input" cols="80" rows="2"></textarea>
            <button id="send_button" type="button">Send</button>
          </form>
        </td>
      </tr>
    </table>

  </body>
</html>
